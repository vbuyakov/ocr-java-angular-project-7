name: orion-microcrm

services:
  back:
    build:
      context: .
      dockerfile: back/Dockerfile
    user: root
    environment:
      SPRING_APPLICATION_NAME: ${SPRING_APP_NAME:-microcrm}
      LOGGING_FILE_PATH: /var/log/app
    volumes:
      - back-logs:/var/log/app
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/profile"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - orioncrm

  front:
    build:
      context: .
      dockerfile: front/Dockerfile
    volumes:
      - front-logs:/var/log/caddy
    depends_on:
      back:
        condition: service_healthy
    networks:
      - orioncrm

  nginx:
    image: nginx:alpine
    volumes:
      - ./misc/docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-logs:/var/log/nginx
    ports:
      - "${APP_PORT:-80}:80"
    depends_on:
      - back
      - front
    networks:
      - orioncrm

volumes:
  nginx-logs:
    name: ${ELK_PROJECT:-ocr-ja7}-nginx-logs
  back-logs:
    name: ${ELK_PROJECT:-ocr-ja7}-back-logs
  front-logs:
    name: ${ELK_PROJECT:-ocr-ja7}-front-logs

networks:
  orioncrm:
    name: ${DOCKER_NETWORK:-orion-microcrm_network}
    external: ${DOCKER_NETWORK_EXTERNAL:-false}
